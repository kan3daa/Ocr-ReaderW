<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Inventory</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1 id="title">Chargement...</h1>
    <div id="books-container">Chargement...</div>

    <script>
    // -------------------------
    // UTILITAIRES
    // -------------------------
    function escapeHTML(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function defaultCover() {
        return '/static/default-cover.png';
    }

    // -------------------------
    // RAFRAÎCHISSEMENT LIVRES
    // -------------------------
    async function refreshBooks() {
        try {
            const res = await fetch('/api/books');
            const books = await res.json();

            document.getElementById('title').textContent = `Nos livres (${books.length})`;

            let html = '';

            books.forEach(book => {
                const couverture = book.couverture || defaultCover();

                html += `
                    <div class="book-item">
                        <img src="${couverture}" 
                            alt="${escapeHTML(book.titre)}" 
                            width="120" height="180"
                            onerror="this.src='${defaultCover()}'">
                        <div class="book-info">
                            <h2>${escapeHTML(book.titre)}</h2>
                            <p>${escapeHTML(book.auteur)}</p>
                            <p>${escapeHTML(String(book.scan_count || 1))}x • ${escapeHTML(book.isbn)}</p>
                        </div>
                    </div>
                `;
            });

            document.getElementById('books-container').innerHTML =
                html || '<p style="text-align:center;color:#999">Aucun livre</p>';

        } catch (err) {
            document.getElementById('books-container').innerHTML =
                '<p style="color:red;text-align:center">Erreur API</p>';
            console.error(err);
        }
    }

    refreshBooks();
    setInterval(refreshBooks, 5000);
    </script>
</body>
</html>
